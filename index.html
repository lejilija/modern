<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Futuristiskt Glidarspel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variabler för futuristiskt tema */
        :root {
            --modern-font: 'Inter', sans-serif;
            /* Mörkt tema med neon-accenter */
            --bg-dark: #1a1a2e; /* Mörkblå/lila bakgrund */
            --bg-medium: #1f1f3a;
            --bg-light: #2a2a4a;
            --accent-cyan: #00ffff;
            --accent-magenta: #ff00ff;
            --accent-lime: #a0ff00;
            --text-light: #e0e0ff;
            --text-medium: #a0a0cc;
            --text-dark: #1a1a2e;
            --glow-cyan: rgba(0, 255, 255, 0.7);
            --glow-magenta: rgba(255, 0, 255, 0.7);
        }

        /* Grundläggande stil + typsnitt för allt */
        body, button, input, select, textarea {
            font-family: var(--modern-font);
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Justera för att ge plats åt knappar */
            min-height: 100vh;
            background: linear-gradient(180deg, var(--bg-dark) 0%, var(--bg-medium) 100%);
            margin: 0;
            padding: 70px 15px 20px 15px; /* Behåll padding upptill för knappar */
            box-sizing: border-box;
            color: var(--text-light);
            overscroll-behavior: none;
            font-size: 14px; /* Något större basstorlek */
        }

        /* Knappar i hörn - modern stil */
        #scoreboard-button, #play-again-button {
            position: fixed;
            top: 15px;
            padding: 10px 15px;
            font-size: 0.9em; /* Något mindre text */
            font-weight: bold;
            border: none;
            border-radius: 20px; /* Rundade hörn */
            cursor: pointer;
            z-index: 100;
            transition: all 0.2s ease;
            box-shadow: 0 0 10px 0 var(--glow-cyan); /* Neonglöd */
        }
        #scoreboard-button {
            right: 15px;
            background-color: var(--accent-magenta);
            color: var(--text-dark);
            box-shadow: 0 0 10px 0 var(--glow-magenta);
        }
        #play-again-button {
            left: 15px;
            background-color: var(--accent-cyan);
            color: var(--text-dark);
            box-shadow: 0 0 10px 0 var(--glow-cyan);
        }
        #scoreboard-button:hover {
            background-color: var(--text-light);
            box-shadow: 0 0 15px 2px var(--glow-magenta);
            transform: scale(1.05);
        }
        #play-again-button:hover {
            background-color: var(--text-light);
            box-shadow: 0 0 15px 2px var(--glow-cyan);
            transform: scale(1.05);
        }
        #scoreboard-button:active, #play-again-button:active {
            transform: scale(0.98);
            box-shadow: 0 0 5px 0 var(--glow-cyan);
        }
         #scoreboard-button:active { box-shadow: 0 0 5px 0 var(--glow-magenta); }


        /* Poängvisning */
        #score-display {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: var(--accent-cyan);
            text-shadow: 0 0 8px var(--glow-cyan);
            order: -1; /* Behåll ovanför spelet */
            font-weight: bold;
        }

        .game-container {
            position: relative;
            border: 2px solid var(--accent-cyan); /* Tunn neonkant */
            background-color: var(--bg-dark); /* Mörk bakgrund för spelplan */
            box-shadow: 0 0 15px 2px var(--glow-cyan); /* Glöd runt container */
            border-radius: 10px; /* Rundade hörn */
            overflow: hidden;
            margin-bottom: 30px;
            width: 100%;
            max-width: 404px; /* Justerad för 2px border */
            box-sizing: border-box;
        }

        canvas {
            display: block;
            width: 100%;
            height: auto;
            max-width: 400px;
            margin: 0 auto;
            /* Ta bort image-rendering, inte relevant för smooth ritning */
            background-color: transparent; /* Låt JS rita bakgrund */
            border-radius: 8px; /* Matcha container inuti */
        }

        /* Overlays (Start/Game Over) - modern stil */
        #start-screen, #game-over-screen {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(26, 26, 46, 0.95); /* Mörk transparent */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            z-index: 10;
            border-radius: 8px; /* Matcha container */
        }

        #game-over-screen { display: none; }

        /* Dölj element när endast omstartsknappen ska visas (samma logik) */
        #game-over-screen.show-restart-only h1,
        #game-over-screen.show-restart-only #final-score,
        #game-over-screen.show-restart-only #save-score-form { display: none; }
        #game-over-screen #restart-button { display: block; margin: 0 auto; }
        #game-over-screen.show-restart-only #restart-button { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); margin-top: 0; }
        #game-over-screen:not(.show-restart-only) #restart-button { display: none; }

        h1 {
            font-size: 2em; /* Större titel */
            margin-bottom: 35px;
            color: var(--accent-cyan);
            line-height: 1.3;
            text-shadow: 0 0 10px var(--glow-cyan);
            font-weight: bold;
        }
        #game-over-screen h1 {
            font-size: 1.8em;
            color: var(--accent-magenta); /* Magenta för Game Over */
            text-shadow: 0 0 10px var(--glow-magenta);
        }
        #final-score {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: var(--text-light);
        }

        /* Knappar - modern stil */
        button, input[type="submit"] {
            padding: 12px 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: linear-gradient(45deg, var(--accent-cyan), var(--accent-magenta));
            color: var(--text-dark);
            border-radius: 25px; /* Mer rundade */
            box-shadow: 0 0 8px 0 var(--glow-cyan);
            transition: all 0.2s ease;
            margin-top: 20px;
            text-shadow: none; /* Ta bort retro-skugga */
            vertical-align: middle;
            box-sizing: border-box;
        }
        button:active, input[type="submit"]:active {
            transform: scale(0.97);
            box-shadow: 0 0 4px 0 var(--glow-cyan);
        }
        button:hover, input[type="submit"]:hover {
             box-shadow: 0 0 15px 2px var(--glow-magenta);
             transform: scale(1.03);
        }
        /* Specifika knappar kan behålla gradient eller få egen färg */
        #start-button { /* Behåll gradient */ }
        #restart-button { /* Behåll gradient */ }

        /* Poängtavla Modal - modern stil */
        #scoreboard-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(10, 10, 20, 0.85); /* Mörkare overlay */
            z-index: 20; align-items: center; justify-content: center;
            padding: 15px; box-sizing: border-box;
        }
        #scoreboard-content {
            background-color: var(--bg-light);
            padding: 25px 30px;
            border-radius: 15px; /* Rundade hörn */
            width: 100%; max-width: 400px; /* Lite bredare */
            max-height: 80%; overflow-y: auto; text-align: center;
            border: 1px solid var(--accent-magenta); /* Tunn kant */
            box-shadow: 0 0 20px 3px var(--glow-magenta); /* Glöd */
        }
        #scoreboard-content h2 {
            margin-bottom: 25px; color: var(--accent-magenta);
            font-size: 1.6em; text-shadow: 0 0 8px var(--glow-magenta);
        }
        #scoreboard-list { list-style: none; padding: 0; margin: 0; text-align: left; }
        #scoreboard-list li {
            padding: 10px 5px; border-bottom: 1px solid var(--bg-medium); /* Subtil avdelare */
            font-size: 1.1em; display: flex; justify-content: space-between;
            color: var(--text-light);
        }
        #scoreboard-list li:last-child { border-bottom: none; }
        #scoreboard-list li span:first-child { /* Namn */
             color: var(--text-medium); margin-right: 15px;
             overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        #scoreboard-list li span:last-child { /* Poäng */
            color: var(--accent-lime); /* Limegrön för poäng */
            font-weight: bold;
        }
        #close-scoreboard {
            margin-top: 25px;
            background: var(--text-medium); /* Gråaktig stäng-knapp */
             color: var(--bg-dark);
             box-shadow: none;
        }
        #close-scoreboard:hover {
            background: var(--text-light);
            box-shadow: 0 0 8px 1px var(--text-medium);
             transform: scale(1.03);
        }

        /* Kontroller - modern stil */
        .controls {
            display: grid; grid-template-columns: repeat(3, auto); grid-template-rows: auto auto;
            gap: 10px; width: auto; justify-items: center; margin-bottom: 20px;
            display: none; /* Visas endast via JS för touch */
        }
        .control-button {
            display: flex; align-items: center; justify-content: center;
            width: 55px; height: 55px;
            background-color: var(--bg-light);
            color: var(--accent-cyan);
            border: 1px solid var(--accent-cyan);
            border-radius: 50%; /* Cirkulära knappar */
            cursor: pointer;
            box-shadow: 0 0 8px 0 var(--glow-cyan);
            transition: all 0.2s ease;
            user-select: none; -webkit-user-select: none; -ms-user-select: none;
            font-size: 1.5em; /* Större ikon/pil */
        }
        .control-button:active {
            box-shadow: 0 0 4px 0 var(--glow-cyan);
            transform: scale(0.95); background-color: var(--accent-cyan); color: var(--bg-dark);
        }
         .control-button:hover {
             background-color: var(--bg-medium);
             box-shadow: 0 0 12px 1px var(--glow-cyan);
         }

        /* Modern pil (Chevron) med borders */
        .arrow {
            display: inline-block;
            border: solid var(--accent-cyan);
            border-width: 0 4px 4px 0; /* Skapar pilspets */
            padding: 5px;
            transition: border-color 0.2s ease;
        }
        .control-button:active .arrow { border-color: var(--bg-dark); }

        .arrow-up { transform: rotate(-135deg); -webkit-transform: rotate(-135deg); margin-bottom: 3px; }
        .arrow-down { transform: rotate(45deg); -webkit-transform: rotate(45deg); margin-top: 3px; }
        .arrow-left { transform: rotate(135deg); -webkit-transform: rotate(135deg); margin-right: 3px; }
        .arrow-right { transform: rotate(-45deg); -webkit-transform: rotate(-45deg); margin-left: 3px; }


        /* Grid placering för ny layout */
        #left-button { grid-column: 1; grid-row: 1; }
        #up-button { grid-column: 2; grid-row: 1; }
        #right-button { grid-column: 3; grid-row: 1; }
        #down-button { grid-column: 2; grid-row: 2; }

        /* Footer */
        footer { margin-top: auto; padding-top: 15px; font-size: 0.8em; color: var(--text-medium); text-align: center; opacity: 0.7; }

        /* Inputfält & Spara-knapp Linjering - modern stil */
        input[type="text"] {
            padding: 12px 15px;
            border: 1px solid var(--accent-cyan);
            border-radius: 20px;
            margin: 0 10px 0 0;
            background-color: var(--bg-medium);
            color: var(--text-light);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.5);
            font-size: 1em;
            width: calc(100% - 150px); /* Anpassa bredd */
            max-width: 200px;
            box-sizing: border-box;
            vertical-align: middle;
            line-height: normal;
            height: auto; /* Låt padding bestämma höjd */
            transition: all 0.2s ease;
        }
         input[type="text"]:focus {
             outline: none;
             border-color: var(--accent-magenta);
             box-shadow: inset 0 0 8px rgba(0,0,0,0.5), 0 0 10px var(--glow-magenta);
         }

          input[type="submit"] {
              padding: 12px 20px; /* Matcha input-höjd */
              font-size: 1em;
              width: auto;
              margin-top: 0; /* Ta bort margin-top */
              height: auto;
              vertical-align: middle;
              /* Behåller gradient från generell knappstil */
          }
          #save-score-form {
              display: flex;
              align-items: center; /* Centrera vertikalt */
              justify-content: center;
              width: 100%;
              max-width: 360px; /* Öka lite för att få plats */
              margin-top: 15px;
          }
    </style>
</head>
<body>
    <button id="play-again-button">Spela</button>
    <button id="scoreboard-button">Topplista</button>

    <div id="score-display">Poäng: 0</div>

    <div class="game-container">
        <div id="start-screen">
             <h1>Glidaren</h1> <button id="start-button">Starta</button>
        </div>
        <div id="game-over-screen">
            <h1>Kollision!</h1> <p id="final-score">Din poäng: 0</p>
            <form id="save-score-form">
                <input type="text" id="player-name" placeholder="Ditt namn" maxlength="12" required> <input type="submit" value="Spara">
            </form>
            <button id="restart-button">Spela igen</button>
        </div>
        <canvas id="gameCanvas" width="400" height="400"></canvas>
    </div>

    <div class="controls" id="touch-controls">
        <button class="control-button" id="up-button"><span class="arrow arrow-up"></span></button>
        <button class="control-button" id="left-button"><span class="arrow arrow-left"></span></button>
        <button class="control-button" id="right-button"><span class="arrow arrow-right"></span></button>
        <button class="control-button" id="down-button"><span class="arrow arrow-down"></span></button>
    </div>

    <div id="scoreboard-modal">
        <div id="scoreboard-content">
            <h2>Topplista</h2>
            <ol id="scoreboard-list"></ol>
            <button id="close-scoreboard">Stäng</button>
        </div>
    </div>

    <footer>powered by Inmemory - Futuristic Edition</footer>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('score-display');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const startButton = document.getElementById('start-button');
        const restartButton = document.getElementById('restart-button');
        const finalScoreDisplay = document.getElementById('final-score');
        const scoreboardButton = document.getElementById('scoreboard-button');
        const playAgainButton = document.getElementById('play-again-button');
        const scoreboardModal = document.getElementById('scoreboard-modal');
        const closeScoreboardButton = document.getElementById('close-scoreboard');
        const scoreboardList = document.getElementById('scoreboard-list');
        const saveScoreForm = document.getElementById('save-score-form');
        const playerNameInput = document.getElementById('player-name');
        const touchControls = document.getElementById('touch-controls');

        // Spelinställningar
        const gridSize = 20; // Behåll gridstorlek för logik
        const canvasSize = 400;
        const tileCount = canvasSize / gridSize;

        // Definiera färger direkt i JS för Canvas (matchar CSS-variabler)
        const colors = {
            bgDark: '#1a1a2e',
            gridColor: 'rgba(42, 42, 74, 0.5)', // svagare grid
            gliderHead: '#00ffff', // Cyan huvud
            gliderBody: '#a0ff00', // Limegrön kropp
            gliderOutline: 'rgba(255, 255, 255, 0.1)', // Subtil vit outline
            foodColor: '#ff00ff', // Magenta mat
            foodGlow: 'rgba(255, 0, 255, 0.8)',
        };

        // Spelvariabler
        let glider; // Byt namn från skier
        let food;
        let score;
        let gameLoopTimeout;
        let gameSpeed = 200; // Återställer till lite snabbare tempo för modern känsla
        let isGameOver;
        const foodTypes = ['energy_orb']; // Ny mattyp

        // Input-buffring
        let nextDx = 0;
        let nextDy = 0;

        // --- Initiering och Start ---
        function initGame() {
            clearTimeout(gameLoopTimeout);
            gameLoopTimeout = null;
            isGameOver = false;
            score = 0;
            updateScoreDisplay();
            // Startposition och initial kropp
            const startX = Math.floor(tileCount / 2);
            const startY = Math.floor(tileCount / 2);
            glider = {
                dx: 0, dy: 0, // Startar stillastående
                // Kroppen är nu en array av {x, y} objekt
                body: [{ x: startX, y: startY }]
            };
            nextDx = 0;
            nextDy = 0;
            gameOverScreen.style.display = 'none';
            gameOverScreen.classList.remove('show-restart-only');
            startScreen.style.display = 'none';
            placeFood();
            gameLoop();
        }
        startButton.addEventListener('click', initGame);
        restartButton.addEventListener('click', initGame);
        playAgainButton.addEventListener('click', initGame);

        // --- Spelloop ---
        function gameLoop() {
            if (isGameOver) { showGameOver(); return; }

            clearTimeout(gameLoopTimeout);

            gameLoopTimeout = setTimeout(() => {
                clearAndDrawBackground(); // Rita modern bakgrund
                drawFood(); // Rita modern mat
                moveGlider(); // Uppdaterad flyttlogik
                drawGlider(); // Rita modern glidare
                checkCollision(); // Samma kollisionslogik
                if (!isGameOver) {
                    gameLoop();
                 } else {
                     showGameOver();
                 }
            }, gameSpeed);
        }

        // --- Ritfunktioner ---
        function clearAndDrawBackground() {
            // Mörk bakgrund
            ctx.fillStyle = colors.bgDark;
            ctx.fillRect(0, 0, canvasSize, canvasSize);

            // Subtilt rutnät
            ctx.strokeStyle = colors.gridColor;
            ctx.lineWidth = 1;
            for (let i = 1; i < tileCount; i++) {
                const pos = i * gridSize;
                // Horisontella linjer
                ctx.beginPath();
                ctx.moveTo(0, pos);
                ctx.lineTo(canvasSize, pos);
                ctx.stroke();
                // Vertikala linjer
                ctx.beginPath();
                ctx.moveTo(pos, 0);
                ctx.lineTo(pos, canvasSize);
                ctx.stroke();
            }
        }

        // Funktion för att rita rundade rektanglar (används för glidaren)
        function drawRoundedRect(x, y, width, height, radius, color, outlineColor = null) {
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.arcTo(x + width, y, x + width, y + radius, radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.arcTo(x + width, y + height, x + width - radius, y + height, radius);
            ctx.lineTo(x + radius, y + height);
            ctx.arcTo(x, y + height, x, y + height - radius, radius);
            ctx.lineTo(x, y + radius);
            ctx.arcTo(x, y, x + radius, y, radius);
            ctx.closePath();
            ctx.fill();

            if (outlineColor) {
                ctx.strokeStyle = outlineColor;
                ctx.lineWidth = 1;
                ctx.stroke();
            }
        }

        function drawGlider() {
            const head = glider.body[0];
            const headX = head.x * gridSize;
            const headY = head.y * gridSize;
            const segmentSize = gridSize * 0.8; // Lite mindre än grid för mellanrum
            const offset = (gridSize - segmentSize) / 2;
            const radius = segmentSize * 0.3; // Rundningsradie

            // Rita kroppen (limegrön)
            for (let i = 1; i < glider.body.length; i++) {
                const segment = glider.body[i];
                drawRoundedRect(
                    segment.x * gridSize + offset,
                    segment.y * gridSize + offset,
                    segmentSize,
                    segmentSize,
                    radius,
                    colors.gliderBody,
                    colors.gliderOutline
                );
            }

            // Rita huvudet (cyan) - lite större och med "ögon"
            const headSize = gridSize * 0.9;
            const headOffset = (gridSize - headSize) / 2;
            const headRadius = headSize * 0.3;
             drawRoundedRect(
                headX + headOffset,
                headY + headOffset,
                headSize,
                headSize,
                headRadius,
                colors.gliderHead,
                colors.gliderOutline
            );

            // Enkla "ögon" på huvudet
            ctx.fillStyle = colors.bgDark; // Mörk färg för ögon
            const eyeSize = headSize * 0.15;
            const eyeOffset = headSize * 0.25;
            // Anpassa ögonens position baserat på riktning (förenklat)
            let eyeX1 = headX + headOffset + eyeOffset;
            let eyeY1 = headY + headOffset + eyeOffset;
            let eyeX2 = headX + headOffset + headSize - eyeOffset - eyeSize;
            let eyeY2 = headY + headOffset + eyeOffset;

            if (glider.dx === -1) { // Vänster
                 eyeX1 = headX + headOffset + eyeOffset;
                 eyeY1 = headY + headOffset + eyeOffset;
                 eyeX2 = headX + headOffset + eyeOffset;
                 eyeY2 = headY + headOffset + headSize - eyeOffset - eyeSize;
            } else if (glider.dx === 1) { // Höger
                 eyeX1 = headX + headOffset + headSize - eyeOffset - eyeSize;
                 eyeY1 = headY + headOffset + eyeOffset;
                 eyeX2 = headX + headOffset + headSize - eyeOffset - eyeSize;
                 eyeY2 = headY + headOffset + headSize - eyeOffset - eyeSize;
            } else if (glider.dy === -1) { // Upp
                eyeX1 = headX + headOffset + eyeOffset;
                eyeY1 = headY + headOffset + eyeOffset;
                eyeX2 = headX + headOffset + headSize - eyeOffset - eyeSize;
                eyeY2 = headY + headOffset + eyeOffset;
            } else if (glider.dy === 1) { // Ner
                 eyeX1 = headX + headOffset + eyeOffset;
                 eyeY1 = headY + headOffset + headSize - eyeOffset - eyeSize;
                 eyeX2 = headX + headOffset + headSize - eyeOffset - eyeSize;
                 eyeY2 = headY + headOffset + headSize - eyeOffset - eyeSize;
            }
             ctx.fillRect(eyeX1, eyeY1, eyeSize, eyeSize);
             ctx.fillRect(eyeX2, eyeY2, eyeSize, eyeSize);

        }

        function drawFood() {
            if (!food) return; // Säkerhetskoll
            const foodX = food.x * gridSize + gridSize / 2; // Centrera i rutan
            const foodY = food.y * gridSize + gridSize / 2;
            const radius = gridSize * 0.35; // Storlek på maten

            // Rita glöd
            ctx.shadowColor = colors.foodGlow;
            ctx.shadowBlur = 15;

            // Rita cirkel
            ctx.fillStyle = colors.foodColor;
            ctx.beginPath();
            ctx.arc(foodX, foodY, radius, 0, Math.PI * 2);
            ctx.closePath();
            ctx.fill();

            // Återställ skugga
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
        }


        // --- Spelmekanik ---
        function moveGlider() { // Byt namn från moveSkier
            // Tillämpa buffrad riktning
            const isOppositeDirection = (nextDx === -glider.dx && glider.dx !== 0) || (nextDy === -glider.dy && glider.dy !== 0);
            if (!isOppositeDirection) {
                 if ((nextDx !== 0 || nextDy !== 0) || (glider.dx !== 0 || glider.dy !== 0)) {
                    glider.dx = nextDx;
                    glider.dy = nextDy;
                 }
            }

            // Beräkna ny huvudposition
            const head = { x: glider.body[0].x + glider.dx, y: glider.body[0].y + glider.dy };
            glider.body.unshift(head); // Lägg till nytt huvud

            const didEatFood = glider.body[0].x === food.x && glider.body[0].y === food.y;
            if (didEatFood) {
                score += 10;
                updateScoreDisplay();
                placeFood(); // Placera ny mat, kroppen växer automatiskt
            } else {
                glider.body.pop(); // Ta bort sista segmentet om ingen mat åts
            }
        }

        function placeFood() {
            let newFoodX, newFoodY, collision;
            while (true) {
                newFoodX = Math.floor(Math.random() * tileCount);
                newFoodY = Math.floor(Math.random() * tileCount);
                collision = false;
                // Kontrollera kollision med glidarens kropp
                for (let i = 0; i < glider.body.length; i++) {
                    if (newFoodX === glider.body[i].x && newFoodY === glider.body[i].y) {
                        collision = true;
                        break;
                    }
                }
                if (!collision) break;
            }
            const foodType = foodTypes[0]; // Alltid 'energy_orb'
            food = { x: newFoodX, y: newFoodY, type: foodType };
        }

        function checkCollision() {
            const head = glider.body[0];
            // Kollision med väggar
            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
                isGameOver = true;
                return;
            }
            // Kollision med sig själv
            for (let i = 1; i < glider.body.length; i++) {
                if (head.x === glider.body[i].x && head.y === glider.body[i].y) {
                    isGameOver = true;
                    return;
                }
            }
        }

        function showGameOver() {
            clearTimeout(gameLoopTimeout);
            gameLoopTimeout = null;
            finalScoreDisplay.textContent = `Din poäng: ${score}`;
            gameOverScreen.classList.remove('show-restart-only');
            gameOverScreen.style.display = 'flex';
            playerNameInput.value = '';
            playerNameInput.focus();
        }

        function updateScoreDisplay() {
            scoreDisplay.textContent = `Poäng: ${score}`;
        }

        // --- Kontroller (Samma logik, men för glidaren) ---
        document.addEventListener('keydown', handleKeyDown);

        function handleKeyDown(event) {
             if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(event.key)) {
                 event.preventDefault();
             }
            changeDirection(event.keyCode);
        }

        function changeDirection(keyCode) {
            if (isGameOver) return;

            const LEFT_KEY = 37;
            const RIGHT_KEY = 39;
            const UP_KEY = 38;
            const DOWN_KEY = 40;

            let newDx = 0;
            let newDy = 0;

            if (keyCode === LEFT_KEY) newDx = -1;
            else if (keyCode === UP_KEY) newDy = -1;
            else if (keyCode === RIGHT_KEY) newDx = 1;
            else if (keyCode === DOWN_KEY) newDy = 1;
            else return;

            const isOpposite = (newDx === -glider.dx && glider.dx !== 0) || (newDy === -glider.dy && glider.dy !== 0);

            if (!isOpposite) {
                nextDx = newDx;
                nextDy = newDy;
            }
        }

        // --- Touch-kontroller ---
        function isTouchDevice() { try { document.createEvent("TouchEvent"); return true; } catch (e) { return false; } }

        if (isTouchDevice()) {
             touchControls.style.display = 'grid'; // Visa kontroller
             document.getElementById('up-button').addEventListener('touchstart', (e) => { e.preventDefault(); changeDirection(38); });
             document.getElementById('down-button').addEventListener('touchstart', (e) => { e.preventDefault(); changeDirection(40); });
             document.getElementById('left-button').addEventListener('touchstart', (e) => { e.preventDefault(); changeDirection(37); });
             document.getElementById('right-button').addEventListener('touchstart', (e) => { e.preventDefault(); changeDirection(39); });
         }

        // --- Poängtavla (Använder ny nyckel) ---
        function getHighScores() {
            const scores = localStorage.getItem('gliderGameHighScores_v1_futuristic'); // Ny nyckel
            return scores ? JSON.parse(scores) : [];
        }

        function saveHighScore(name, score) {
            const scores = getHighScores();
            scores.push({ name, score });
            scores.sort((a, b) => b.score - a.score);
            scores.splice(10); // Behåll topp 10
            localStorage.setItem('gliderGameHighScores_v1_futuristic', JSON.stringify(scores)); // Spara med ny nyckel
        }

        function displayHighScores() {
            const scores = getHighScores();
            scoreboardList.innerHTML = '';
            if (scores.length === 0) {
                scoreboardList.innerHTML = '<li>Inga poäng sparade!</li>';
            } else {
                scores.forEach((entry, index) => {
                    const li = document.createElement('li');
                    const displayName = entry.name.length > 12 ? entry.name.substring(0, 12) + '...' : entry.name; // Längre namn tillåtet
                    li.innerHTML = `<span>${index + 1}. ${displayName}</span><span>${entry.score} p</span>`;
                    scoreboardList.appendChild(li);
                });
            }
        }

        // Uppdaterad knapplogik (samma funktionalitet)
        scoreboardButton.addEventListener('click', () => {
            if (!isGameOver && startScreen.style.display === 'none' && gameLoopTimeout) {
                clearTimeout(gameLoopTimeout);
                gameLoopTimeout = null;
            }
            displayHighScores();
            scoreboardModal.style.display = 'flex';
        });

        closeScoreboardButton.addEventListener('click', () => {
            scoreboardModal.style.display = 'none';
            if (gameOverScreen.classList.contains('show-restart-only')) {
                 gameOverScreen.style.display = 'flex';
            } else if (!isGameOver && startScreen.style.display === 'none' && !gameLoopTimeout) {
                gameLoop();
            }
        });

        saveScoreForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const playerName = playerNameInput.value.trim();
            if (playerName) {
                saveHighScore(playerName, score);
                gameOverScreen.classList.add('show-restart-only');
                gameOverScreen.style.display = 'none';
                displayHighScores();
                scoreboardModal.style.display = 'flex';
            } else {
                playerNameInput.focus();
            }
        });

        // Kör igång när sidan laddats
        clearAndDrawBackground(); // Rita bakgrunden direkt

    </script>
</body>
</html>
